services:
  # ==========================================
  # BACKEND SERVICE
  # ==========================================
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: zora-backend
    restart: unless-stopped
    
    environment:
      # Node environment
      - NODE_ENV=${NODE_ENV:-production}
      
      # Server configuration
      - PORT=${BACKEND_PORT:-8000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # CORS configuration
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8080}
      
      # SMTP configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Zora Website}
      
      # Email recipients
      - EMAIL_INFO=${EMAIL_INFO}
      - EMAIL_SALES=${EMAIL_SALES}
      - EMAIL_SUPPORT=${EMAIL_SUPPORT}
      - EMAIL_ADMIN=${EMAIL_ADMIN}
      
      # Rate limiting
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-10}
    
    networks:
      - app-network
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${BACKEND_PORT:-8000}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (adjust for production)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ==========================================
  # FRONTEND SERVICE
  # ==========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Build-time API URL configuration
        - VITE_API_URL=${VITE_API_URL:-http://localhost:8080/api}
    
    container_name: zora-frontend
    restart: unless-stopped
    
    environment:
      - PORT=${FRONTEND_PORT:-3000}
      - NODE_ENV=${NODE_ENV:-production}
    
    networks:
      - app-network
    
    depends_on:
      backend:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${FRONTEND_PORT:-3000}/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    
    # Resource limits (adjust for production)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ==========================================
  # CADDY REVERSE PROXY
  # ==========================================
  caddy:
    image: caddy:2-alpine
    container_name: zora-caddy
    restart: unless-stopped
    
    ports:
      - "${CADDY_PORT:-8080}:${CADDY_PORT:-8080}"
    
    volumes:
      # Caddyfile configuration
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      
      # Persistent data for certificates and config
      - caddy_data:/data
      - caddy_config:/config
    
    environment:
      # Port configuration
      - CADDY_PORT=${CADDY_PORT:-8080}
      - CADDY_HTTP_PORT=${CADDY_HTTP_PORT:-}
      
      # Service hostnames
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=${FRONTEND_PORT:-3000}
      - BACKEND_HOST=backend
      - BACKEND_PORT=${BACKEND_PORT:-8000}
      
      # SSL/HTTPS configuration
      - AUTO_HTTPS=${AUTO_HTTPS:-off}
      - ACME_EMAIL=${ACME_EMAIL:-admin@zora-edu.ae}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
    
    networks:
      - app-network
    
    depends_on:
      - frontend
      - backend
    
    # Resource limits (adjust for production)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

# ==========================================
# NETWORKS
# ==========================================
networks:
  app-network:
    driver: bridge
    name: zora-network

# ==========================================
# VOLUMES
# ==========================================
volumes:
  # Persistent storage for Caddy certificates and configuration
  caddy_data:
    name: zora-caddy-data
  caddy_config:
    name: zora-caddy-config
